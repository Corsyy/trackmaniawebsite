<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Most WRs ‚Äî Trackmania Events</title>
  <meta name="description" content="Players with the most Trackmania world records across all official campaigns, TOTD, and club campaigns."/>
  <meta name="theme-color" content="#0a0f1a"/>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">
  <link rel="shortcut icon" href="/logo.png">
  <style>
    :root{--bg:#0a0f1a;--text:#e6ecff;--muted:#9bb0ff;--accent:#3aa0ff;--accent-2:#6dfbff;--accent-glow:0 0 24px rgba(61,165,255,.35),0 0 48px rgba(61,165,255,.2)}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body.bg-track-curves{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(58,160,255,.10), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(109,251,255,.08), transparent 70%),
        linear-gradient(180deg,#07101c,#0a0f1a 40%,#060a14 100%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
    }
    body.bg-track-curves::before{
      content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%236DAFFF' stop-opacity='.10'/><stop offset='100%' stop-color='%233AE0FF' stop-opacity='.06'/></linearGradient><filter id='blur'><feGaussianBlur stdDeviation='1.4'/></filter></defs><g fill='none' stroke='url(%23g)' stroke-width='2' filter='url(%23blur)'><path d='M-100 700 C300 620 450 480 900 520 C1100 540 1300 620 1400 680'/><path d='M-120 520 C260 460 520 390 940 420 C1180 440 1320 520 1420 600' stroke-width='1.5'/><path d='M-140 350 C220 330 520 300 900 330 C1180 350 1360 420 1500 520' stroke-width='1'/></g></svg>");
      background-size:cover;opacity:.6;mix-blend-mode:screen;
    }
    body.bg-track-curves::after{
      content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.035'/></svg>");
      background-size:280px 280px;animation:noiseShift 6s steps(2,end) infinite;
    }
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,15,26,.9),rgba(10,15,26,.65) 60%,rgba(10,15,26,0));backdrop-filter:blur(8px);border-bottom:1px solid rgba(109,251,255,.12)}
    .container{width:min(1200px,92vw);margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:.9rem 0}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800;letter-spacing:.2px}
    .brand-badge{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--accent-glow)}
    .btn{padding:.6rem .95rem;border:1px solid rgba(109,251,255,.25);border-radius:12px;background:linear-gradient(180deg,rgba(16,24,44,.9),rgba(16,24,44,.6));color:var(--text);font-weight:700;transition:.2s}
    .btn:hover{transform:translateY(-1px) scale(1.02);filter:brightness(1.06)}
    main{max-width:1100px;margin:0 auto;padding:1.5rem}
    h1{font-size:1.7rem;margin-bottom:.4rem;font-weight:900;text-shadow:0 0 12px rgba(61,165,255,.25)}
    .meta{color:var(--muted);font-size:.95rem;margin-bottom:1rem}
    .controls{display:flex;gap:.6rem;align-items:center;margin-bottom:1rem}
    .input{width:280px;max-width:60vw;padding:.6rem .8rem;border-radius:12px;border:1px solid rgba(109,251,255,.22);background:#0c1224;color:var(--text)}
    .card{border:1px solid rgba(109,251,255,.25);background:rgba(15,21,36,.55);backdrop-filter:blur(12px) saturate(180%);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4),0 0 20px rgba(61,165,255,.2);padding:1rem}

    /* Podium styles */
    .podium-head { display:flex; gap:.6rem; align-items:center; justify-content:space-between; margin:.25rem 0 .8rem; }
    .podium-ctrls { display:flex; gap:.5rem; align-items:center; }
    .podium-list { display:flex; gap:.8rem; flex-wrap:wrap; }
    .podium-item {
      flex:1 1 220px;
      min-width:220px;
      border:1px solid rgba(109,251,255,.18);
      background:rgba(12,18,36,.6);
      border-radius:14px; padding:.75rem .9rem;
      display:flex; align-items:center; gap:.7rem;
    }
    .podium-medal { font-size:1.25rem }
    .badge { border:1px solid rgba(109,251,255,.25); padding:.2rem .5rem; border-radius:999px; font-size:.85rem; background:rgba(109,251,255,.08) }

    table{width:100%;border-collapse:collapse}
    th,td{padding:.75rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{opacity:.9}
    .ts{opacity:.75}
    .pager{display:flex;gap:.6rem;align-items:center;justify-content:flex-end;margin:.8rem 0}
    .skeleton{opacity:.7;padding:1rem}
  </style>
  <link rel="dns-prefetch" href="https://trackmaniawebsite.onrender.com">
  <link rel="preconnect" href="https://trackmaniawebsite.onrender.com" crossorigin>
  <link rel="prefetch" href="/wrleaderboard" as="document">
  <link rel="prefetch" href="/recentwrs" as="document">
</head>
<body class="bg-track-curves">
<header>
  <div class="container">
    <a class="brand" href="/index"><span class="brand-badge">üèÅ</span><span>Most WRs</span></a>
    <div style="display:flex;gap:.5rem;">
      <a class="btn" href="/recentwrs">WR Table</a>
      <a class="btn" href="/">Home</a>
    </div>
  </div>
</header>

<main>
  <h1>Players With The Most World Records</h1>
  <div id="meta" class="meta">Loading‚Ä¶</div>

  <div class="controls">
    <input id="q" class="input" type="search" placeholder="Search player or accountId‚Ä¶">
    <button class="btn" id="clear">Clear</button>
  </div>

  <!-- Monthly Podium Card -->
  <section class="card" style="margin-bottom:1rem;">
    <div class="podium-head">
      <div>
        <strong>Monthly WR Podium</strong>
        <span id="podiumMeta" class="meta" style="margin-left:.4rem; font-size:.9rem"></span>
      </div>
      <div class="podium-ctrls">
        <label for="ym" class="meta">Month:</label>
        <input id="ym" type="month" class="input" style="width:auto; padding:.4rem .6rem">
        <button id="loadPodium" class="btn">Load</button>
      </div>
    </div>
    <div id="podiumList" class="podium-list">
      <div class="meta">Loading podium‚Ä¶</div>
    </div>
  </section>

  <div class="pager">
    <button id="prevBtn" class="btn">Prev</button>
    <span id="pageInfo" class="meta"></span>
    <button id="nextBtn" class="btn">Next</button>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>WRs</th>
          <th class="ts">Most Recent</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="4" class="skeleton">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>
</main>

<script>
const API_BASE = "https://trackmaniawebsite.onrender.com";
const PAGE_SIZE = 25;
const FETCH_LIMIT = 100;

let allPlayers = [];
let page = Number(new URLSearchParams(location.search).get('page')) || 1;

function fmtTs(ts){
  if (ts === null || ts === undefined) return "‚Äî";
  const n = Number(ts);
  const ms = Number.isFinite(n) ? (n > 1e12 ? n : n*1000) : Date.parse(ts);
  return isNaN(ms) ? "‚Äî" : new Date(ms).toLocaleString();
}

async function resolveNames(ids = []) {
  if (!ids.length) return {};
  try {
    const url = `${API_BASE}/api/debug-names?ids=${encodeURIComponent(ids.join(","))}`;
    const r = await fetch(url);
    if (!r.ok) return {};
    const data = await r.json();
    const arr = Array.isArray(data?.data) ? data.data : [];
    const map = {};
    for (const row of arr) {
      if (row && row.id) map[row.id] = row.name || row.id;
    }
    return map;
  } catch {
    return {};
  }
}

function renderPage(p=1){
  const total = allPlayers.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  page = Math.min(Math.max(1, p), totalPages);

  const start = (page - 1) * PAGE_SIZE;
  const slice = allPlayers.slice(start, start + PAGE_SIZE);

  const tb = document.getElementById("rows");
  tb.innerHTML = slice.map((pl, i) => `
    <tr>
      <td>${start + i + 1}</td>
      <td>${pl.prettyName || pl.displayName || pl.accountId || "‚Äî"}</td>
      <td>${pl.wrCount}</td>
      <td class="ts">${fmtTs(pl.latestTs)}</td>
    </tr>
  `).join("");

  document.getElementById("pageInfo").textContent = `Page ${page} of ${totalPages}`;
  const prev = document.getElementById("prevBtn");
  const next = document.getElementById("nextBtn");
  prev.disabled = page <= 1;
  next.disabled = page >= totalPages;
  prev.onclick = () => goTo(page - 1);
  next.onclick = () => goTo(page + 1);

  const params = new URLSearchParams(location.search);
  params.set('page', page);
  history.replaceState({}, '', `${location.pathname}?${params}`);
}

function goTo(p){ if (p >= 1) renderPage(p); }

let fetchCtrl = null;
let debounce = null;

async function load(){
  try{
    if (fetchCtrl) fetchCtrl.abort();
    fetchCtrl = new AbortController();

    document.getElementById("rows").innerHTML = `<tr><td colspan="4" class="skeleton">Loading‚Ä¶</td></tr>`;

    const url = new URL(API_BASE + "/api/wr-players");
    url.searchParams.set("limit", FETCH_LIMIT);
    const q = (document.getElementById("q").value || "").trim();
    if (q) url.searchParams.set("q", q);

    const r = await fetch(url, { signal: fetchCtrl.signal, cache: "no-store" });
    if (!r.ok) throw new Error(await r.text());
    const j = await r.json();

    const players = Array.isArray(j.players) ? j.players : [];

    const needIds = [...new Set(
      players.filter(p => p.accountId && (!p.displayName || p.displayName === p.accountId))
             .map(p => p.accountId)
    )];

    const names = await resolveNames(needIds);

    allPlayers = players.map(p => ({
      ...p,
      prettyName: names[p.accountId] || p.displayName || p.accountId
    }));

    const ago = Math.max(0, Date.now() - (j.fetchedAt || 0));
    document.getElementById("meta").textContent =
      `Fetched ${Math.round(ago/1000)}s ago ‚Äî ${new Date(j.fetchedAt || Date.now()).toLocaleTimeString()}`;

    renderPage(page);
  }catch(e){
    if (e.name === "AbortError") return;
    console.error(e);
    document.getElementById("meta").textContent = "Failed to load player leaderboard.";
    document.getElementById("rows").innerHTML = `<tr><td colspan="4">Error loading data.</td></tr>`;
  }
}

document.getElementById("q").addEventListener("input", ()=>{
  clearTimeout(debounce);
  debounce = setTimeout(()=>{ page = 1; load(); }, 250);
});
document.getElementById("clear").onclick = () => { document.getElementById("q").value=""; page=1; load(); };

/* -------- Monthly podium (tries /api/wr-podium, then /api/top-monthly) -------- */
function ymDefaultUTC(){
  const now = new Date();
  const y = now.getUTCFullYear();
  const m = String(now.getUTCMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function fmtNum(n){ try { return Number(n).toLocaleString(); } catch { return String(n); } }

async function fetchJSONWithFallback(ym){
  // Try new route first
  const try1 = `${API_BASE}/api/wr-podium?month=${encodeURIComponent(ym)}`;
  // Fallback (older route)
  const try2 = `${API_BASE}/api/top-monthly?ym=${encodeURIComponent(ym)}&limit=3`;

  // helper to fetch and validate
  const one = async (url) => {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  };

  try {
    const j = await one(try1);
    // normalize to common shape
    if (Array.isArray(j.top)) return { ym: j.ym || ym, top: j.top };
    if (Array.isArray(j.podium)) return { ym: j.month || ym, top: j.podium }; // just in case
    // if some other shape, coerce best-effort
    return { ym: j.ym || j.month || ym, top: j.top || j.podium || [] };
  } catch {
    const k = await one(try2);
    return { ym: k.ym || ym, top: Array.isArray(k.top) ? k.top : [] };
  }
}

async function loadPodium(){
  const ym = document.getElementById("ym").value || ymDefaultUTC();
  const list = document.getElementById("podiumList");
  const meta = document.getElementById("podiumMeta");
  list.innerHTML = `<div class="meta">Loading podium‚Ä¶</div>`;
  meta.textContent = "";

  try{
    const { ym: resolvedYm, top } = await fetchJSONWithFallback(ym);

    if (!top.length) {
      list.innerHTML = `<div class="meta">No records yet for ${resolvedYm}.</div>`;
      meta.textContent = "";
      return;
    }

    const medals = ["ü•á","ü•à","ü•â"];
    list.innerHTML = top.slice(0,3).map((p, idx) => `
      <div class="podium-item">
        <div class="podium-medal">${medals[idx] || ""}</div>
        <div style="min-width:0">
          <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${p.displayName || p.accountId}
          </div>
          <div class="meta" style="font-size:.9rem">
            <span class="badge">${fmtNum(p.wrs || p.wrCount || 0)} WRs</span>
            <span style="margin-left:.35rem; opacity:.9">
              ${fmtNum(p.bySource?.official||0)} official ‚Ä¢ ${fmtNum(p.bySource?.totd||0)} totd ‚Ä¢ ${fmtNum(p.bySource?.club||0)} club
            </span>
          </div>
        </div>
      </div>
    `).join("");

    meta.textContent = `Month: ${resolvedYm}`;
  }catch(e){
    console.error(e);
    list.innerHTML = `<div class="meta">Failed to load podium.</div>`;
  }
}

// init podium
(function initPodium(){
  const ymIn = document.getElementById("ym");
  const btn  = document.getElementById("loadPodium");
  if (ymIn) ymIn.value = ymDefaultUTC();
  if (btn) btn.addEventListener("click", loadPodium);
  loadPodium(); // load current month on page load
})();

// initial table load
load();
// occasional refresh
setInterval(() => load(), 60 * 60 * 1000);
</script>

<script>
  // keep server warm
  setInterval(() => {
    fetch('https://trackmaniawebsite.onrender.com/api/ping').catch(()=>{});
  }, 5 * 60 * 1000);
  // prefetches
  const prefetch = (url) => {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = url;
    link.as = 'fetch';
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
  };
  const wrBtn = document.querySelector('a[href="/wrleaderboard"]');
  const tblBtn = document.querySelector('a[href="/recentwrs"]');
  if (wrBtn) wrBtn.addEventListener('mouseenter', () => prefetch('https://trackmaniawebsite.onrender.com/api/wr-players?limit=100'), { once:true });
  if (tblBtn) tblBtn.addEventListener('mouseenter', () => prefetch('https://trackmaniawebsite.onrender.com/api/wr-latest?limit=100'), { once:true });
</script>

</body>
</html>
