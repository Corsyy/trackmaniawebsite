<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Track of the Day — Trackmania Events</title>
  <meta name="description" content="Track of the Day and Cup of the Day results for Trackmania. View maps, authors, and winners by month." />
  <link rel="icon" type="image/png" href="/logo.png" />
  <style>
    :root{
      --bg:#0a0f1a; --panel:#0f1524; --text:#e6ecff; --muted:#9bb0ff;
      --accent:#3aa0ff; --accent-2:#6dfbff; --border: rgba(109,251,255,.15); --border-2: rgba(109,251,255,.2);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--bg); color:var(--text)}
    .container{width:min(1200px,92vw);margin:0 auto;}
    header{background:#0f1524;border-bottom:1px solid rgba(109,251,255,.12);padding:1rem 0;position:sticky;top:0;z-index:10;}
    .nav{display:flex;align-items:center;justify-content:space-between;}
    .brand{font-weight:800;letter-spacing:.3px;display:flex;align-items:center;gap:.4rem;}
    .nav a{color:var(--muted);text-decoration:none;margin-left:1rem;}
    .nav a:hover{color:var(--accent-2);}
    .title{font-size:1.9rem;font-weight:900;margin:2rem 0 0.5rem;}
    .sub{color:var(--muted);margin-bottom:1rem}
    .controls{display:flex;align-items:center;gap:.6rem;margin:0.75rem 0 1.25rem;}
    .btn{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:.5rem .8rem;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--accent-2)}
    .month-pill{border:1px solid var(--border);padding:.45rem .8rem;border-radius:999px;color:var(--muted);background:linear-gradient(180deg,rgba(15,21,36,.9),rgba(15,21,36,.6))}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:640px){.grid{grid-template-columns:1fr;}}
    .cotd-card{border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,rgba(15,21,36,.9),rgba(15,21,36,.6));overflow:hidden;transition:transform .15s ease;}
    .cotd-card:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(61,165,255,.25);}
    .cotd-thumb{aspect-ratio:16/9;background-size:cover;background-position:center;border-bottom:1px dashed var(--border-2);position:relative;}
    .cotd-thumb.empty{background-image:linear-gradient(135deg, rgba(58,160,255,.12), rgba(109,251,255,.08));}
    .cotd-thumb.empty::after{content:"No preview"; position:absolute; inset:0; display:grid; place-items:center; color:var(--muted); font-size:.9rem;}
    .cotd-body{padding:1rem;}
    .cotd-title{font-weight:800;font-size:1.1rem;margin:0 0 .4rem;}
    .cotd-meta{color:var(--muted);font-size:.9rem;margin-top:.25rem;}
    footer{border-top:1px solid rgba(109,251,255,.12);padding:1.2rem 0;text-align:center;color:var(--muted);margin-top:3rem;}
    .empty{border:1px dashed var(--border-2);border-radius:12px;padding:1rem;text-align:center;color:var(--muted);}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a href="/" class="brand">← Back to Events</a>
      <div>
        <a href="/">Home</a>
        <a href="/kacky">Kacky Finishes</a>
        <a href="/cotd.html">Track of the Day</a>
      </div>
    </div>
  </header>

  <main class="container">
    <h1 class="title">Track of the Day</h1>
    <div class="sub">Browse by month. Authors, thumbnails, and COTD winners are included when available.</div>
    <div class="controls">
      <button id="prev" class="btn">← Prev</button>
      <div id="month-pill" class="month-pill">—</div>
      <button id="next" class="btn">Next →</button>
    </div>

    <div class="grid" id="cotd-grid">
      <article class="cotd-card"><div class="cotd-body">Loading month…</div></article>
    </div>
  </main>

  <footer>
    © <span id="year"></span> Trackmania Events
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymOf(d){ return d.getUTCFullYear() + "-" + pad2(d.getUTCMonth()+1); }
    function cleanTM(str = "") {
      return String(str).replace(/\$[0-9a-fA-F]{3}|\$[a-zA-Z]|\$[0-9a-fA-F]/g, "").trim();
    }

    // Start on current month
    let current = new Date();
    let currentYM = ymOf(current);

    const grid = document.getElementById('cotd-grid');
    const pill = document.getElementById('month-pill');

    async function loadMonth(ym){
      pill.textContent = ym;
      grid.innerHTML = `<article class="cotd-card"><div class="cotd-body">Loading ${ym}…</div></article>`;

      try{
        const res = await fetch(`/data/totd/${ym}.json?cb=${Date.now()}`, {cache: 'no-store'});
        if(!res.ok){
          grid.innerHTML = `<div class="empty">No data file for ${ym}. It will appear after your GitHub Action runs.</div>`;
          return;
        }
        const data = await res.json();
        const items = Array.isArray(data) ? data : (data.tracks || []);
        if(!items.length){
          grid.innerHTML = `<div class="empty">No tracks found for ${ym}.</div>`;
          return;
        }

        grid.innerHTML = '';
        for(const item of items){
          const img = item.image || item.thumbnail || '';
          const name = cleanTM(item.map_name || item.name || 'Track of the Day');
          const date = item.date || item.day || '';
          const author = cleanTM(item.author || item.author_name || 'Unknown');

          // winners: array of { division, displayName }
          let winnersText = '—';
          if (Array.isArray(item.winners) && item.winners.length){
            // Show up to first 3 divisions, then “+N more”
            const first = item.winners.slice(0,3).map(w => `Div ${w.division}: ${cleanTM(w.displayName || '—')}`);
            winnersText = first.join(' • ');
            if (item.winners.length > 3) winnersText += ` • +${item.winners.length - 3} more`;
          } else if (item.cotd_winner) {
            winnersText = cleanTM(item.cotd_winner);
          }

          const card = document.createElement('article');
          card.className = 'cotd-card';
          card.innerHTML = `
            <div class="cotd-thumb ${img ? '' : 'empty'}" style="${img ? `background-image:url('${img}')` : ''}"></div>
            <div class="cotd-body">
              <div class="cotd-title">${name}</div>
              ${date ? `<div class="cotd-meta">${date}</div>` : ''}
              <div class="cotd-meta">Author: ${author}</div>
              <div class="cotd-meta">COTD Winners: ${winnersText}</div>
            </div>
          `;
          grid.appendChild(card);
        }
      }catch(e){
        console.error(e);
        grid.innerHTML = `<div class="empty">Failed to load ${ym} (network or CORS).</div>`;
      }
    }

    // Month navigation
    function shiftMonth(delta){
      const y = Number(currentYM.slice(0,4));
      const m = Number(currentYM.slice(5)) - 1; // 0-11
      const d = new Date(Date.UTC(y, m + delta, 1));
      currentYM = ymOf(d);
      loadMonth(currentYM);
    }
    document.getElementById('prev').addEventListener('click', () => shiftMonth(-1));
    document.getElementById('next').addEventListener('click', () => shiftMonth(+1));

    // Initial load (current month)
    loadMonth(currentYM);
  </script>
</body>
</html>
