<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Community Highlights ‚Äî Trackmania Events</title>
<meta name="theme-color" content="#0a0f1a"/>
<link rel="icon" type="image/png" href="/logo.png">
<style>
body.bg-track-curves{background:radial-gradient(1200px 600px at 20% -10%,rgba(58,160,255,.10),transparent 60%),radial-gradient(900px 500px at 110% 10%,rgba(109,251,255,.08),transparent 70%),linear-gradient(180deg,#07101c,#0a0f1a 40%,#060a14 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;position:relative;background-color:#0a0f1a;}

body.bg-track-curves::before{content:"";position:fixed;inset:0;z-index:0;pointer-events:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%236DAFFF' stop-opacity='.10'/><stop offset='100%' stop-color='%233AE0FF' stop-opacity='.06'/></linearGradient><filter id='blur'><feGaussianBlur stdDeviation='1.4'/></filter></defs><g fill='none' stroke='url(%23g)' stroke-width='2' filter='url(%23blur)'><path d='M-100 700 C300 620 450 480 900 520 C1100 540 1300 620 1400 680'/><path d='M-120 520 C260 460 520 390 940 420 C1180 440 1320 520 1420 600' stroke-width='1.5'/><path d='M-140 350 C220 330 520 300 900 330 C1180 350 1360 420 1500 520' stroke-width='1'/></g></svg>");background-repeat:no-repeat;background-size:cover;background-position:50% 0;mix-blend-mode:screen;opacity:.6;will-change:transform;transform:translateZ(0);}

body.bg-track-curves::after{content:"";position:fixed;inset:0;z-index:0;pointer-events:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.035'/></svg>");background-repeat:repeat;background-size:280px 280px;animation:noiseShift 6s steps(2,end) infinite;will-change:background-position;transform:translateZ(0);}


/* make sure content is above the overlays */
header, main, footer { position: relative; z-index: 1; }

@keyframes noiseShift {
  from { background-position: 0 0; }
  to   { background-position: 140px 0; }
}




  :root{
    --bg:#0a0f1a; --text:#e6ecff; --muted:#9bb0ff;
    --accent:#3aa0ff; --accent-2:#6dfbff;
    --border:rgba(109,251,255,.25); --card:rgba(15,21,36,.55);
    --shadow:0 10px 30px rgba(0,0,0,.4),0 0 20px rgba(61,165,255,.2);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:
      radial-gradient(1200px 600px at 20% -10%, rgba(58,160,255,.10), transparent 60%),
      radial-gradient(900px 500px at 110% 10%, rgba(109,251,255,.08), transparent 70%),
      linear-gradient(180deg,#07101c,#0a0f1a 40%,#060a14 100%);
      color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,15,26,.9),rgba(10,15,26,.65) 60%,rgba(10,15,26,0));
         backdrop-filter:blur(8px);border-bottom:1px solid rgba(109,251,255,.12)}
  .container{width:min(1200px,92vw);margin:0 auto;padding:1rem 0;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:.6rem;align-items:center;font-weight:800}
  .badge{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
         background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 24px rgba(61,165,255,.35),0 0 48px rgba(61,165,255,.2)}
  .btn{padding:.6rem .95rem;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,rgba(16,24,44,.9),rgba(16,24,44,.6));color:var(--text);font-weight:700;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px) scale(1.02);filter:brightness(1.06)}
  .btn.ghost{background:transparent}
  main{width:min(1200px,92vw);margin:1.25rem auto 3rem}
  h1{font-size:1.9rem;margin-bottom:.25rem;font-weight:900;text-shadow:0 0 12px rgba(61,165,255,.25)}
  .meta{color:var(--muted);opacity:.9}

  .controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin:1rem 0}
  .chip{border:1px solid rgba(255,255,255,.15);padding:.4rem .7rem;border-radius:999px;background:rgba(16,24,44,.7);cursor:pointer}
  .chip.active{border-color:var(--border);box-shadow:0 0 24px rgba(61,165,255,.35)}
  .search{flex:1;min-width:220px}
  .search input{width:100%;padding:.65rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(10,15,26,.6);color:var(--text)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
  @media(max-width:1050px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:680px){.grid{grid-template-columns:1fr}}

  .card{border:1px solid var(--border);background:var(--card);backdrop-filter:blur(12px) saturate(180%);
        border-radius:18px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
  .thumb{aspect-ratio:16/9;background:#02060f;border-bottom:1px solid rgba(255,255,255,.08);display:grid;place-items:center}
  .thumb iframe,.thumb video{width:100%;height:100%;display:block}
  .body{padding:.85rem}
  .title{font-weight:800;margin-bottom:.25rem}
  .sub{color:var(--muted);font-size:.92rem;margin-bottom:.5rem}
  .tags{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.35rem}
  .tag{padding:.25rem .55rem;border:1px solid rgba(255,255,255,.15);border-radius:999px;font-size:.8rem;background:rgba(16,24,44,.7)}
  .row{display:flex;justify-content:space-between;align-items:center;gap:.6rem;margin-top:.5rem}
  .like{border:1px solid rgba(255,255,255,.15);background:transparent;border-radius:10px;padding:.35rem .6rem;cursor:pointer}
  .like.liked{border-color:var(--border)}

  .empty{opacity:.8;text-align:center;padding:2rem;border:1px dashed rgba(255,255,255,.12);border-radius:12px}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;padding:1rem}
  .modal.open{display:flex}
  .dialog{width:min(820px,96vw);border:1px solid var(--border);background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:1rem}
  .dialog h2{margin-bottom:.5rem}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
  .field{display:flex;flex-direction:column;gap:.35rem}
  .field input,.field textarea,.field select{
    padding:.65rem .75rem;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(10,15,26,.6);color:var(--text);outline:none}
  .field textarea{min-height:90px;resize:vertical}
  .row-2{grid-column:1/-1}
  .small{font-size:.88rem;color:var(--muted)}
  .pill{padding:.25rem .55rem;border:1px dashed rgba(255,255,255,.2);border-radius:999px;margin-left:.35rem}
  .drop{border:1.5px dashed rgba(255,255,255,.18);border-radius:14px;padding:1rem;display:grid;place-items:center;background:rgba(14,20,34,.5)}
  .drop.drag{border-color:var(--accent-2)}
  .actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.6rem}
  .error{color:#ffb3b3;margin-top:.2rem}
  .success{color:#b3ffda;margin-top:.2rem}
</style>
</head>
<body class="bg-track-curves">
<header>
  <div class="container">
    <div class="brand"><span class="badge">üé¨</span><span>Community Highlights</span></div>
    <div style="display:flex;gap:.5rem">
      <a class="btn ghost" href="/">Home</a>
      <button id="openModal" class="btn">Submit Highlight</button>
    </div>
  </div>
</header>

<main>
  <h1>Community Highlights</h1>
  <div class="meta">Share your best WR attempts, saves, fails, and stylish lines.</div>

  <div class="controls">
    <div class="chips" id="chips" style="display:flex;gap:.5rem;flex-wrap:wrap">
      <span class="chip active" data-tag="All">All</span>
      <span class="chip" data-tag="WR">WR</span>
      <span class="chip" data-tag="WR Attempt">WR Attempt</span>
      <span class="chip" data-tag="Save">Save</span>
      <span class="chip" data-tag="Fail">Fail</span>
      <span class="chip" data-tag="Style">Style</span>
      <span class="chip" data-tag="Kacky">Kacky</span>
      <span class="chip" data-tag="TOTD">TOTD</span>
    </div>
    <div class="search"><input id="q" type="search" placeholder="Search player, map, tag‚Ä¶"></div>
    <button id="refresh" class="btn ghost">Refresh</button>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No highlights yet. Be the first to submit!</div>
</main>

<!-- Modal: Submit -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="dialog">
    <h2>Submit a Highlight</h2>
    <form id="form" class="form" novalidate>
      <div class="field">
        <label>Username (required)</label>
        <input id="playerName" name="playerName" type="text" placeholder="e.g., Corsy" required>
      </div>

      <div class="field">
        <label>Map name (required)</label>
        <input id="mapName" name="mapName" type="text" placeholder="Realm CE" required>
      </div>

      <div class="field">
        <label>Map UID</label>
        <input id="mapUid" name="mapUid" type="text" placeholder="4xw1kNQh‚Ä¶">
      </div>

      <div class="field">
        <label>Account ID (optional)</label>
        <input id="accountId" name="accountId" type="text" placeholder="Ubisoft accountId">
      </div>

      <div class="field row-2">
        <label>Tags</label>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap">
          <label class="pill"><input type="checkbox" name="tags" value="WR"> WR</label>
          <label class="pill"><input type="checkbox" name="tags" value="WR Attempt"> WR Attempt</label>
          <label class="pill"><input type="checkbox" name="tags" value="Save"> Save</label>
          <label class="pill"><input type="checkbox" name="tags" value="Fail"> Fail</label>
          <label class="pill"><input type="checkbox" name="tags" value="Style"> Style</label>
          <label class="pill"><input type="checkbox" name="tags" value="Kacky"> Kacky</label>
          <label class="pill"><input type="checkbox" name="tags" value="TOTD"> TOTD</label>
          <label class="pill">Custom: <input id="customTag" type="text" placeholder="your tag" style="margin-left:.35rem;padding:.25rem .45rem;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:rgba(10,15,26,.6);color:var(--text);width:120px"></label>
        </div>
        <div class="small">You can add a custom tag (e.g., ‚ÄúTech‚Äù, ‚ÄúFullspeed‚Äù).</div>
      </div>

      <div class="field row-2">
        <label>Description</label>
        <textarea id="description" name="description" maxlength="300" placeholder="Short context (max 300 chars)"></textarea>
        <div class="small"><span id="descLen">0</span>/300</div>
      </div>

      <div class="field row-2">
        <label>Video URL (YouTube or Twitch) <span class="small">(or upload a file below)</span></label>
        <input id="videoUrl" name="videoUrl" type="url" placeholder="https://youtu.be/‚Ä¶ or https://twitch.tv/videos/‚Ä¶">
        <div class="small">Provide a URL <b>or</b> upload a file. Not both.</div>
      </div>

      <div class="field row-2">
        <label>Upload file (mp4/webm/mov/mkv or GBX)</label>
        <div id="drop" class="drop">
          <div>Drag & drop here or <button id="pick" type="button" class="btn ghost">Choose file</button></div>
          <input id="file" name="file" type="file" accept=".mp4,.webm,.mov,.mkv,.gbx" hidden>
        </div>
        <div class="small" id="fileInfo">No file selected.</div>
      </div>

      <div class="field row-2">
        <label><input id="consent" type="checkbox" required> I agree to show this publicly and I own the rights.</label>
      </div>

      <!-- honeypot -->
      <input type="text" id="website" name="website" style="display:none">

      <div id="status" class="small"></div>
      <div class="actions row-2">
        <button type="button" id="close" class="btn ghost">Cancel</button>
        <button type="submit" class="btn">Submit</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = {
  list: (q, tag) => {
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (tag && tag !== 'All') params.set('tag', tag);
    params.set('limit', '60');
    return fetch(`/api/highlights?${params.toString()}`, {cache:'no-store'}).then(r=>r.json());
  },
  submit: (fd) => fetch('/api/highlights/submit', { method:'POST', body:fd })
};

// ====== FEED ======
const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const chips = document.getElementById('chips');
const search = document.getElementById('q');
const refresh = document.getElementById('refresh');
let activeTag = 'All', q = '';

function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function yt(url){ try{const u=new URL(url); if(/youtu\.be/.test(u.hostname)) return u.pathname.slice(1);
  if(/youtube\.com/.test(u.hostname)) return u.searchParams.get('v')||null; }catch{} return null; }
function twVod(url){ try{const u=new URL(url); if(!/twitch\.tv/.test(u.hostname)) return null;
  const m = u.pathname.match(/\/videos\/(\d+)/); return m?m[1]:null; }catch{} return null; }

function cardHTML(h){
  // media
  let media = `<div class="thumb"><div class="meta">No preview</div></div>`;
  if(h.videoUrl){
    const v = yt(h.videoUrl);
    const t = twVod(h.videoUrl);
    if(v) media = `<div class="thumb"><iframe src="https://www.youtube.com/embed/${v}" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe></div>`;
    else if(t) media = `<div class="thumb"><iframe src="https://player.twitch.tv/?video=${t}&parent=${location.hostname}" frameborder="0" allowfullscreen></iframe></div>`;
  }else if(h.fileUrl && /\.(mp4|webm|mov|mkv)$/i.test(h.fileUrl)){
    media = `<div class="thumb"><video src="${escapeHTML(h.fileUrl)}" controls preload="metadata"></video></div>`;
  }else if(h.fileUrl && /\.gbx$/i.test(h.fileUrl)){
    media = `<div class="thumb" style="display:flex;align-items:center;justify-content:center"><a class="btn" href="${escapeHTML(h.fileUrl)}" download>Download GBX</a></div>`;
  }
  const tags = (h.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');
  const likeKey = `hl-like-${h.id}`;
  const liked = localStorage.getItem(likeKey)==='1';
  const likeCount = (h.likes||0) + (liked?1:0);
  return `
  <article class="card" data-id="${h.id}">
    ${media}
    <div class="body">
      <div class="title">${escapeHTML(h.title || h.mapName || 'Highlight')}</div>
      <div class="sub">${escapeHTML(h.playerName || 'Unknown')} ‚Ä¢ ${escapeHTML(h.mapName || '')}</div>
      ${h.description ? `<div class="small">${escapeHTML(h.description)}</div>` : ''}
      <div class="tags">${tags}</div>
      <div class="row">
        <button class="like ${liked?'liked':''}" data-like="${h.id}">üëç <span>${likeCount}</span></button>
        <div class="small">${new Date(h.submittedAt||Date.now()).toLocaleString()}</div>
      </div>
    </div>
  </article>`;
}

async function load(){
  const data = await API.list(q, activeTag).catch(()=>({rows:[]}));
  const rows = Array.isArray(data?.rows)? data.rows : [];
  grid.innerHTML = rows.map(cardHTML).join('');
  empty.style.display = rows.length ? 'none' : 'block';
}

chips.addEventListener('click', e=>{
  const c = e.target.closest('.chip'); if(!c) return;
  [...chips.children].forEach(x=>x.classList.remove('active'));
  c.classList.add('active'); activeTag = c.dataset.tag; load();
});
search.addEventListener('input', e=>{ q = e.target.value.trim(); load(); });
refresh.addEventListener('click', load);
grid.addEventListener('click', e=>{
  const btn = e.target.closest('[data-like]'); if(!btn) return;
  const id = btn.getAttribute('data-like'); const key = `hl-like-${id}`;
  if(localStorage.getItem(key)==='1'){ localStorage.removeItem(key); }
  else{ localStorage.setItem(key,'1'); }
  // re-render just the count
  const span = btn.querySelector('span'); const n = parseInt(span.textContent||'0',10);
  const liked = btn.classList.toggle('liked');
  span.textContent = liked ? n+1 : Math.max(0,n-1);
});
load();

// ====== MODAL + SUBMIT ======
const modal = document.getElementById('modal');
const openModal = document.getElementById('openModal');
const closeBtn = document.getElementById('close');
const form = document.getElementById('form');
const pick = document.getElementById('pick');
const fileInput = document.getElementById('file');
const drop = document.getElementById('drop');
const fileInfo = document.getElementById('fileInfo');
const statusEl = document.getElementById('status');
const desc = document.getElementById('description'); const descLen = document.getElementById('descLen');

openModal.onclick = ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); };
closeBtn.onclick = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); form.reset(); statusEl.textContent=''; fileInfo.textContent='No file selected.'; };
modal.addEventListener('click', e=>{ if(e.target===modal) closeBtn.click(); });

desc.addEventListener('input', ()=> descLen.textContent = desc.value.length);
pick.onclick = ()=> fileInput.click();
fileInput.onchange = ()=>{ const f=fileInput.files?.[0]; fileInfo.textContent = f ? `${f.name} ‚Äî ${(f.size/1024/1024).toFixed(1)} MB` : 'No file selected.'; };
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(f){ fileInput.files=e.dataTransfer.files; fileInfo.textContent=`${f.name} ‚Äî ${(f.size/1024/1024).toFixed(1)} MB`; }});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  statusEl.className='small'; statusEl.textContent='';
  // requireds
  const name = form.playerName.value.trim();
  const mapName = form.mapName.value.trim();
  if(!name || !mapName){ statusEl.className='error'; statusEl.textContent='Username and Map name are required.'; return; }
  // url vs file check
  const url = form.videoUrl.value.trim();
  const file = fileInput.files?.[0];
  if(!url && !file){ statusEl.className='error'; statusEl.textContent='Add a YouTube/Twitch URL or upload a file.'; return; }
  if(url && file){ statusEl.className='error'; statusEl.textContent='Use either a URL or a file, not both.'; return; }
  if(!form.consent.checked){ statusEl.className='error'; statusEl.textContent='Please confirm consent.'; return; }
  if(form.website.value){ return; } // honeypot

  const tags = [...form.querySelectorAll('input[name="tags"]:checked')].map(i=>i.value);
  const custom = document.getElementById('customTag').value.trim();
  if(custom) tags.push(custom);

  const fd = new FormData();
  fd.append('playerName', name);
  fd.append('mapName', mapName);
  fd.append('mapUid', form.mapUid.value.trim());
  fd.append('accountId', form.accountId.value.trim());
  fd.append('description', form.description.value.trim());
  fd.append('tags', JSON.stringify(tags));
  if(url) fd.append('videoUrl', url);
  if(file) fd.append('file', file);

  try{
    statusEl.textContent = 'Uploading‚Ä¶';
    const res = await API.submit(fd);
    if(!res.ok){ throw new Error(await res.text()); }
    statusEl.className='success'; statusEl.textContent='Submitted! Your highlight will appear after review.';
    form.reset(); fileInfo.textContent='No file selected.'; descLen.textContent='0';
    setTimeout(()=>{ closeBtn.click(); load(); }, 700);
  }catch(err){
    console.error(err);
    statusEl.className='error'; statusEl.textContent='Upload failed. Please try again.';
  }
});
</script>
</body>
</html>
