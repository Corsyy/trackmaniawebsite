<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Recent World Records ‚Äî Trackmania Events</title>
  <meta name="description" content="Most recent Trackmania world records across all official campaigns, TOTD, and club campaigns."/>
  <meta name="theme-color" content="#0a0f1a"/>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">
  <link rel="shortcut icon" href="/logo.png">
  <style>
    :root{--bg:#0a0f1a;--text:#e6ecff;--muted:#9bb0ff;--accent:#3aa0ff;--accent-2:#6dfbff;--accent-glow:0 0 24px rgba(61,165,255,.35),0 0 48px rgba(61,165,255,.2)}
    *{box-sizing:border-box;margin:0;padding:0} html,body{height:100%}
    body.bg-track-curves{background:radial-gradient(1200px 600px at 20% -10%, rgba(58,160,255,.10), transparent 60%),radial-gradient(900px 500px at 110% 10%, rgba(109,251,255,.08), transparent 70%),linear-gradient(180deg,#07101c,#0a0f1a 40%,#060a14 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased}
    body.bg-track-curves::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%236DAFFF' stop-opacity='.10'/><stop offset='100%' stop-color='%233AE0FF' stop-opacity='.06'/></linearGradient><filter id='blur'><feGaussianBlur stdDeviation='1.4'/></filter></defs><g fill='none' stroke='url(%23g)' stroke-width='2' filter='url(%23blur)'><path d='M-100 700 C300 620 450 480 900 520 C1100 540 1300 620 1400 680'/><path d='M-120 520 C260 460 520 390 940 420 C1180 440 1320 520 1420 600' stroke-width='1.5'/><path d='M-140 350 C220 330 520 300 900 330 C1180 350 1360 420 1500 520' stroke-width='1'/></g></svg>");background-size:cover;opacity:.6;mix-blend-mode:screen}
    body.bg-track-curves::after{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.035'/></svg>");background-size:280px 280px;animation:noiseShift 6s steps(2,end) infinite}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,15,26,.9),rgba(10,15,26,.65) 60%,rgba(10,15,26,0));backdrop-filter:blur(8px);border-bottom:1px solid rgba(109,251,255,.12)}
    .container{width:min(1200px,92vw);margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:.9rem 0}
    .brand{display:flex;align-items:center;gap:.6rem;font-weight:800;letter-spacing:.2px}
    .brand-badge{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--accent-glow)}
    .btn{padding:.6rem .95rem;border:1px solid rgba(109,251,255,.25);border-radius:12px;background:linear-gradient(180deg,rgba(16,24,44,.9),rgba(16,24,44,.6));color:var(--text);font-weight:700;transition:.2s}
    .btn:hover{transform:translateY(-1px) scale(1.02);filter:brightness(1.06)}
    main{max-width:1100px;margin:0 auto;padding:1.5rem} h1{font-size:1.7rem;margin-bottom:.4rem;font-weight:900;text-shadow:0 0 12px rgba(61,165,255,.25)} .meta{color:var(--muted);font-size:.95rem;margin-bottom:1rem}
    .card{border:1px solid rgba(109,251,255,.25);background:rgba(15,21,36,.55);backdrop-filter:blur(12px) saturate(180%);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4),0 0 20px rgba(61,165,255,.2);padding:1rem}
    table{width:100%;border-collapse:collapse} th,td{padding:.75rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left} th{opacity:.9}
    .time{font-variant-numeric:tabular-nums} .ts{opacity:.7;font-size:.9em}
    .pager{display:flex;gap:.6rem;align-items:center;justify-content:flex-end;margin:.8rem 0}
    .skeleton{opacity:.7;padding:1rem}

    /* ===== Mobile-friendly tables ===== */
    @media (max-width: 640px){
      h1{ font-size:1.45rem; line-height:1.2; }
      .container{ padding:.7rem 0; }
      main{ padding:1rem .9rem; }

      .btn{ padding:.55rem .8rem; border-radius:10px; }
      .controls{ flex-wrap:wrap; gap:.5rem; }
      .input{ width:100%; max-width:100%; }

      .pager{ justify-content:center; gap:.5rem; }
      .pager .btn{ min-width:92px; }

      /* ===== Mobile Table: Stacked Card Style ===== */
      table.mobile-stack{
        border-collapse:separate !important;
        border-spacing:0 !important;
      }
      table.mobile-stack thead{ display:none; }
      table.mobile-stack tbody{ display:block; margin:0; padding:0; }

      table.mobile-stack tr{
        display:block;
        padding:.55rem .75rem;
        margin-bottom:.55rem;
        border-radius:10px;
        background:rgba(15,21,36,.75);
        box-shadow:0 0 8px rgba(61,165,255,.08);
        border:1px solid rgba(255,255,255,.08);
      }

      /* Remove leftover borders & fix alignment */
      table.mobile-stack th,
      table.mobile-stack td,
      th, td { border:0 !important; }

      table.mobile-stack td{
        display:grid;
        grid-template-columns:96px 1fr;
        align-items:baseline;
        gap:.5rem;
        padding:.35rem 0;
        line-height:1.25;
        font-size:.9rem;
      }

      table.mobile-stack td::before{
        content:attr(data-label);
        opacity:.7;
        font-size:.85rem;
        color:var(--muted);
        margin:0;
        min-width:0;
        flex-shrink:0;
      }

      /* Truncate long map UIDs or player names */
      .truncate{
        max-width:60vw;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }
    }
  </style>
  <link rel="dns-prefetch" href="https://trackmaniawebsite.onrender.com">
  <link rel="preconnect" href="https://trackmaniawebsite.onrender.com" crossorigin>
  <link rel="prefetch" href="/wrleaderboard" as="document">
  <link rel="prefetch" href="/recentwrs" as="document">
</head>
<body class="bg-track-curves">
<header>
  <div class="container">
    <a class="brand" href="/index"><span class="brand-badge">üèÅ</span><span>Recent WRs</span></a>
    <div style="display:flex;gap:.5rem;">
      <a class="btn" href="/wrleaderboard">WR Leaderboard</a>
      <a class="btn" href="/">Home</a>
    </div>
  </div>
</header>

<main>
  <h1>Most Recent World Records</h1>
  <div id="meta" class="meta">Loading‚Ä¶</div>

  <div class="pager">
    <button id="prevBtn" class="btn">Prev</button>
    <span id="pageInfo" class="meta"></span>
    <button id="nextBtn" class="btn">Next</button>
  </div>

  <div class="card">
    <table class="mobile-stack">
      <thead>
        <tr>
          <th>#</th>
          <th>Map UID</th>
          <th>Holder</th>
          <th class="time">WR Time</th>
          <th class="ts">Set</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="5" class="skeleton">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
const API_BASE = "https://trackmaniawebsite.onrender.com";
const PAGE_SIZE = 25;    // rows per page
const FETCH_LIMIT = 100; // how many records to fetch once

let allRows = [];
let page = Number(new URLSearchParams(location.search).get('page')) || 1;

function fmt(ms){
  if(!Number.isFinite(ms)) return "‚Äî";
  const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), x=ms%1000;
  const pad=(n,w=2)=>String(n).padStart(w,"0");
  return `${pad(m)}:${pad(s)}:${String(x).padStart(3,"0")}`;
}
function fmtTs(ts){
  if (ts === null || ts === undefined) return "‚Äî";
  const n = Number(ts);
  const ms = Number.isFinite(n) ? (n > 1e12 ? n : n*1000) : Date.parse(ts);
  return isNaN(ms) ? "‚Äî" : new Date(ms).toLocaleString();
}

/* ========== NEW: helpers to safely render clickable player links ========== */
function escapeHTML(s=''){
  return s.replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
}
function playerLinkHTML({ id, name }) {
  return escapeHTML(name || id || '‚Äî');
}
/* ======================================================================== */

async function resolveNames(ids = []) {
  if (!ids.length) return {};
  try {
    const url = `${API_BASE}/api/debug-names?ids=${encodeURIComponent(ids.join(","))}`;
    const r = await fetch(url);
    if (!r.ok) return {};
    const data = await r.json();
    const arr = Array.isArray(data?.data) ? data.data : [];
    const map = {};
    for (const row of arr) {
      if (row && row.id) map[row.id] = row.name || row.id;
    }
    return map;
  } catch {
    return {};
  }
}

function renderPage(p = 1) {
  const total = allRows.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  page = Math.min(Math.max(1, p), totalPages);

  const start = (page - 1) * PAGE_SIZE;
  const slice = allRows.slice(start, start + PAGE_SIZE);

  const $rows = document.getElementById("rows");
  $rows.innerHTML = "";

  slice.forEach((row, i) => {
    const pretty = row.prettyName || row.displayName || row.accountId || "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td data-label="#">${start + i + 1}</td>` +
      `<td data-label="Map UID"><span class="truncate">${escapeHTML(row.mapUid || '')}</span></td>` +
      `<td data-label="Holder"><span class="truncate">${playerLinkHTML({ id: row.accountId, name: pretty })}</span></td>` +
      `<td data-label="WR Time" class="time">${row.timeMs != null ? fmt(row.timeMs) : "‚Äî"}</td>` +
      `<td data-label="Set" class="ts">${fmtTs(row.timestamp)}</td>`;
    $rows.appendChild(tr);
  });

  // pager controls
  document.getElementById("pageInfo").textContent = `Page ${page} of ${totalPages}`;
  const prev = document.getElementById("prevBtn");
  const next = document.getElementById("nextBtn");
  prev.disabled = page <= 1;
  next.disabled = page >= totalPages;
  prev.onclick = () => goTo(page - 1);
  next.onclick = () => goTo(page + 1);

  // keep ?page in URL
  const params = new URLSearchParams(location.search);
  params.set('page', page);
  history.replaceState({}, '', `${location.pathname}?${params}`);
}

function goTo(p){ if (p >= 1) renderPage(p); }

async function load(){
  try {
    document.getElementById("rows").innerHTML = `<tr><td colspan="5" class="skeleton">Loading‚Ä¶</td></tr>`;
    const res = await fetch(`${API_BASE}/api/wr-latest?limit=${FETCH_LIMIT}`, { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    const j = await res.json();
    const rows = Array.isArray(j.rows) ? j.rows : [];

    // collect ids lacking proper names
    const needIds = [...new Set(rows
      .filter(r => r.accountId && (!r.displayName || r.displayName === r.accountId))
      .map(r => r.accountId))];

    const names = await resolveNames(needIds);

    // attach prettyName once
    allRows = rows.map(r => ({ ...r, prettyName: names[r.accountId] || r.displayName || r.accountId }));

    const ago = Math.max(0, Date.now() - (j.fetchedAt || 0));
    document.getElementById("meta").textContent =
      `Fetched ${Math.round(ago/1000)}s ago ‚Äî ${new Date(j.fetchedAt || Date.now()).toLocaleTimeString()}`;

    renderPage(page);
  } catch (e) {
    console.error(e);
    document.getElementById("meta").textContent = "Failed to load recent WRs.";
    document.getElementById("rows").innerHTML = `<tr><td colspan="5">Error loading data.</td></tr>`;
  }
}

// initial
load();
// optional light auto-refresh
setInterval(() => load(), 60 * 60 * 1000); // once every hour
</script>

<script>
  // keep server warm
  setInterval(() => {
    fetch('https://trackmaniawebsite.onrender.com/api/ping').catch(()=>{});
  }, 5 * 60 * 1000);
  // prefetches
  const prefetch = (url) => {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = url;
    link.as = 'fetch';
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
  };
  const wrBtn = document.querySelector('a[href="/wrleaderboard"]');
  const tblBtn = document.querySelector('a[href="/recentwrs"]');
  if (wrBtn) wrBtn.addEventListener('mouseenter', () => prefetch('https://trackmaniawebsite.onrender.com/api/wr-players?limit=100'), { once:true });
  if (tblBtn) tblBtn.addEventListener('mouseenter', () => prefetch('https://trackmaniawebsite.onrender.com/api/wr-latest?limit=100'), { once:true });
</script>

</body>
</html>
