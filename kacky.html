<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kacky Finishes ‚Äî Trackmania Events</title>
  <meta name="description" content="Upload and view Trackmania Kacky finish clips. Community submissions, moderated for quality." />
  <style>
    :root{
      --bg:#0a0f1a;
      --panel:#0f1524;
      --panel-2:#0c1020;
      --ink:#e6ecff;
      --text:#e6ecff;
      --muted:#9fb3ff;
      --accent:#3aa0ff;
      --accent-2:#6dfbff;
      --brand:#6dfbff;
      --border:rgba(109,251,255,.22);
      --ring:0 0 0 3px rgba(61,165,255,.25);
      --accent-glow:0 0 24px rgba(61,165,255,.35), 0 0 48px rgba(61,165,255,.2);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ====== Track Curves background (matches index) ====== */
    body.bg-track-curves{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(58,160,255,.10), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(109,251,255,.08), transparent 70%),
        linear-gradient(180deg, #07101c, #0a0f1a 40%, #060a14 100%);
    }
    /* prettier-ignore */
    body.bg-track-curves::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800' preserveAspectRatio='xMidYMid slice'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%236DAFFF' stop-opacity='.10'/><stop offset='100%' stop-color='%233AE0FF' stop-opacity='.06'/></linearGradient><filter id='blur'><feGaussianBlur stdDeviation='1.4'/></filter></defs><g fill='none' stroke='url(%23g)' stroke-width='2' filter='url(%23blur)'><path d='M-100 700 C300 620 450 480 900 520 C1100 540 1300 620 1400 680'/><path d='M-120 520 C260 460 520 390 940 420 C1180 440 1320 520 1420 600' stroke-width='1.5'/><path d='M-140 350 C220 330 520 300 900 330 C1180 350 1360 420 1500 520' stroke-width='1'/></g></svg>");
      background-size:cover;background-position:center;background-repeat:no-repeat;opacity:.6;mix-blend-mode:screen;
    }
    /* prettier-ignore */
    body.bg-track-curves::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='.035'/></svg>");
      background-size:280px 280px; animation:noiseShift 6s steps(2,end) infinite;
    }
    @keyframes noiseShift{50%{transform:translate3d(0,0,0)}50.01%{transform:translate3d(.5px,.5px,0)}}

    /* ====== Header ====== */
    header{
      background:linear-gradient(180deg, rgba(10,15,26,.92), rgba(10,15,26,.72) 60%, rgba(10,15,26,0));
      backdrop-filter:blur(8px);
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid rgba(109,251,255,.18);
    }
    .nav-container{
      width:min(1200px,92vw); margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; padding:1rem 0;
    }
    .brand{
      font-weight:800; font-size:1.1rem; letter-spacing:.3px; display:flex; align-items:center; gap:.5rem; color:var(--accent-2)
    }
    .btn-nav{
      padding:.55rem 1rem; border:1px solid rgba(109,251,255,.25); border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#001220;
      font-weight:800; cursor:pointer; text-decoration:none; transition:transform .2s ease, filter .2s ease;
      box-shadow:var(--accent-glow)
    }
    .btn-nav:hover{transform:translateY(-1px); filter:brightness(1.05)}

    /* ====== Layout ====== */
    .container{width:min(1200px,92vw);margin:0 auto;padding:1.4rem 0 2.2rem}
    h1{font-size:2rem;margin:.2rem 0 1rem;text-shadow:0 0 12px rgba(61,165,255,.25)}
    .hint{font-size:.95rem;color:var(--muted)}

    /* ====== Card Grid ====== */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem}
    .card{
      background:rgba(15,21,36,.55);
      border:1px solid var(--border);
      border-radius:14px; padding:1rem; display:flex; flex-direction:column; gap:.6rem; min-height:180px;
      backdrop-filter:blur(10px) saturate(160%);
      box-shadow:0 10px 30px rgba(0,0,0,.4), 0 0 18px rgba(61,165,255,.18);
      transition:transform .2s ease, box-shadow .2s ease, filter .2s ease;
    }
    .card:hover{transform:translateY(-3px);box-shadow:0 0 18px rgba(61,165,255,.35);filter:brightness(1.03)}
    .card .slot{opacity:.85;font-size:.9rem;color:var(--muted)}
    .badge{display:inline-block;font-size:.75rem;padding:.25rem .5rem;border:1px solid rgba(255,255,255,.2);border-radius:.5rem;background:rgba(255,255,255,.06)}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}

    /* ====== Buttons / Inputs ====== */
    .btn {
  padding: .6rem .95rem;
  border: 1px solid rgba(109,251,255,.25);
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(16,24,44,.9), rgba(16,24,44,.6));
  color: var(--text);
  font-weight: 700;
  transition: .2s;
}
.btn:hover {
  transform: translateY(-1px) scale(1.02);
  filter: brightness(1.06);
}

    .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(109,251,255,.25);box-shadow:none}
    .btn[disabled]{opacity:.55;cursor:not-allowed;transform:none;filter:none}
    .input{
      width:100%;padding:.7rem .9rem;margin:.4rem 0;border-radius:10px;border:1px solid rgba(109,251,255,.25);
      background:#0c1224;color:#e6ecff;outline:none
    }
    .input:focus{border-color:var(--brand);box-shadow:var(--ring)}

    /* ====== Embeds ====== */
    .card iframe{width:100%;height:220px;border:0;border-radius:10px;background:#000}

    /* ====== Modals ====== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:100;padding:1rem}
    .modal.open{display:flex}
    .modal-card{
      background:rgba(15,21,36,.85);
      border:1px solid rgba(109,251,255,.25);
      border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.6), 0 0 28px rgba(61,165,255,.25);
      width:min(950px,94vw); max-height:90vh; overflow:auto; backdrop-filter:blur(12px) saturate(160%);
    }
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1rem;border-bottom:1px dashed rgba(255,255,255,.12)}
    .modal-body{padding:1rem}
    .player-frame{aspect-ratio:16/9;width:100%;border:0;border-radius:12px;background:#000}

    /* Small sparkle underline for h1 (optional flair) */
    .title-line{position:relative;display:inline-block}
    .title-line::after{content:"";position:absolute;left:0;right:0;bottom:-6px;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  </style>
</head>
<body class="bg-track-curves">
  <header>
    <div class="nav-container">
      <div class="brand">üèéÔ∏è Kacky Reloaded 6 finishes</div>
      <a href="/" class="btn-nav">Home</a>
    </div>
  </header>

  <div class="container">
    <h1 class="title-line">Kacky Finishes</h1>
    <p class="hint">Upload your kacky finishes, try to keep them in order when you are submitting finishes. If they are not in order it will be denied and you will have to reupload it once again.</p>
    <div id="clipsGrid" class="grid"></div>
  </div>

  <!-- Submit modal (per-slot) -->
  <div class="modal" id="submit-modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>Submit Kacky Clip</strong>
        <button class="btn ghost" data-close-submit>Close</button>
      </div>
      <div class="modal-body">
        <form id="submitForm">
          <div class="row">
            <input class="input" name="slot" id="slotField" type="number" min="1" max="75" placeholder="Slot # (1‚Äì75)" required />
            <input class="input" name="title" placeholder="Title" required />
          </div>
          <input class="input" name="url" placeholder="Twitch or YouTube URL" required />
          <div class="row">
            <input class="input" name="map" placeholder="Map (optional)" />
            <input class="input" name="thumb" placeholder="Thumbnail URL (optional)" />
          </div>
          <input class="input" name="date" type="datetime-local" />
          <div class="row" style="align-items:center">
            <button class="btn" type="submit">Send</button>
            <span id="submitStatus" class="hint"></span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Player lightbox -->
  <div class="modal" id="player-modal" aria-hidden="true">
    <div class="modal-card" style="width:min(1280px,96vw)">
      <div class="modal-head">
        <strong>Player</strong>
        <button class="btn ghost" data-close-player>Close</button>
      </div>
      <div class="modal-body">
        <iframe id="playerFrame" class="player-frame" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SUPABASE_URL = "https://lertzsobphopkoyaxrwk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlcnR6c29icGhvcGtveWF4cndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjU4MzksImV4cCI6MjA3NjQwMTgzOX0.Vgpdlh8MHG21QIQW10iL1pztUYRPxJXTHMwg0gTPlWI";
    const H = { headers:{ apikey:SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` } };

    // ===== Helpers =====
    function twitchParents(){
      const set = new Set(["trackmaniaevents.com","www.trackmaniaevents.com", location.hostname]);
      return [...set].map(p=>`parent=${encodeURIComponent(p)}`).join('&');
    }

    function buildEmbedURL(raw){
      try{
        const u = new URL(raw);
        const host = u.hostname.replace(/^www\./,'');

        // YouTube
        if (host === 'youtube.com' || host === 'm.youtube.com') {
          const id = u.searchParams.get('v');
          if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}?modestbranding=1&rel=0&playsinline=1`;
          const parts = u.pathname.split('/').filter(Boolean);
          if (parts[0] === 'shorts' && parts[1]) {
            return `https://www.youtube.com/embed/${encodeURIComponent(parts[1])}?modestbranding=1&rel=0&playsinline=1`;
          }
        }
        if (host === 'youtu.be') {
          const id = u.pathname.replace('/','');
          if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}?modestbranding=1&rel=0&playsinline=1`;
        }

        // Twitch
        if (host === 'clips.twitch.tv') {
          const slug = u.pathname.split('/').filter(Boolean)[0];
          if (slug) return `https://clips.twitch.tv/embed?clip=${encodeURIComponent(slug)}&${twitchParents()}&autoplay=false`;
        }
        if (host.endsWith('twitch.tv')) {
          const parts = u.pathname.split('/').filter(Boolean);
          const clipIdx = parts.indexOf('clip');
          if (clipIdx >= 0 && parts[clipIdx+1]) {
            const slug = parts[clipIdx+1];
            return `https://clips.twitch.tv/embed?clip=${encodeURIComponent(slug)}&${twitchParents()}&autoplay=false`;
          }
          const vIdx = parts.indexOf('videos');
          if (vIdx >= 0 && parts[vIdx+1]) {
            return `https://player.twitch.tv/?video=${encodeURIComponent(parts[vIdx+1])}&${twitchParents()}&autoplay=false`;
          }
          if (parts[0]) {
            return `https://player.twitch.tv/?channel=${encodeURIComponent(parts[0])}&${twitchParents()}&autoplay=false`;
          }
        }
        return raw;
      }catch(e){ return raw; }
    }

    async function loadClips(){
      try{
        const [approvedRes, allRes] = await Promise.all([
          fetch(`${SUPABASE_URL}/rest/v1/kacky_clips?approved=eq.true&select=id,slot,title,url,map,date,thumb`, H),
          fetch(`${SUPABASE_URL}/rest/v1/kacky_clips?select=slot`, H)
        ]);
        const approved = await approvedRes.json();
        const all = await allRes.json();
        const occupied = new Set(all.map(r => Number(r.slot)));
        render(approved, occupied);
      }catch(err){
        console.error(err);
        document.getElementById('clipsGrid').innerHTML = '<p>Failed to load clips.</p>';
      }
    }

    function render(clips, occupied){
      const grid = document.getElementById('clipsGrid');
      grid.innerHTML = '';
      for(let i=1;i<=75;i++){
        const clip = clips.find(c => Number(c.slot)===i);
        const isOccupied = occupied.has(i);
        const card = document.createElement('div');
        card.className = 'card';

        if(clip){
          const src = buildEmbedURL(clip.url);
          card.innerHTML = `
            <div class="slot">Slot ${i}${clip.map?` ¬∑ ${escapeHtml(clip.map)}`:''}</div>
            <strong>${escapeHtml(clip.title||'Kacky Finish')}</strong>
            <iframe src="${src}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            <div class="row">
              <button class='btn openPlayer' data-url='${encodeURIComponent(src)}'>View / Fullscreen</button>
              <span class="badge">Locked (filled)</span>
            </div>`;
        } else if(isOccupied){
          card.innerHTML = `
            <div class="slot">Slot ${i}</div>
            <em>Submission pending review</em>
            <div class="row">
              <button class='btn' disabled>Upload disabled</button>
              <span class="badge">1 per slot</span>
            </div>`;
        } else {
          card.innerHTML = `
            <div class="slot">Slot ${i}</div>
            <em>No clip yet</em>
            <div class="row">
              <button class='btn upload' data-slot='${i}'>Upload for Slot ${i}</button>
            </div>`;
        }
        grid.appendChild(card);
      }
    }

    // Simple HTML escaper for titles/maps
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    // ===== Modal wiring =====
    const submitModal = document.getElementById('submit-modal');
    const playerModal = document.getElementById('player-modal');
    const slotField = document.getElementById('slotField');
    const playerFrame = document.getElementById('playerFrame');

    function openSubmit(slot){ if(slot){ slotField.value = slot; } submitModal.classList.add('open'); submitModal.setAttribute('aria-hidden','false'); }
    function closeSubmit(){ submitModal.classList.remove('open'); submitModal.setAttribute('aria-hidden','true'); }
    function openPlayer(url){ playerFrame.src = decodeURIComponent(url); playerModal.classList.add('open'); playerModal.setAttribute('aria-hidden','false'); }
    function closePlayer(){ playerFrame.src = ''; playerModal.classList.remove('open'); playerModal.setAttribute('aria-hidden','true'); }

    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.matches('.upload')){ const slot = t.getAttribute('data-slot'); openSubmit(slot); }
      if(t.matches('[data-close-submit]')) closeSubmit();
      if(t.matches('[data-close-player]')) closePlayer();
      if(t.matches('.openPlayer')){ const url = t.getAttribute('data-url'); openPlayer(url); }
      if(t.classList.contains('modal')){ if(t.id==='submit-modal') closeSubmit(); if(t.id==='player-modal') closePlayer(); }
    });

    // ===== Submission handling =====
    (function(){
      const form=document.getElementById('submitForm');
      const status=document.getElementById('submitStatus');

      function isValidClipUrl(u){ try{ const h=new URL(u).hostname; return /twitch\.tv|youtube\.com|youtu\.be/i.test(h); } catch{ return false; } }
      function clampSlot(n){ n=Number(n||0); return Math.min(75, Math.max(1, n)); }

      form?.addEventListener('submit', async e => {
        e.preventDefault();
        status.textContent='Checking slot‚Ä¶';

        const fd = new FormData(form);
        const dateRaw = (fd.get('date')||'').toString().trim();
        const payload = {
          title: (fd.get('title')||'').toString().trim(),
          url:   (fd.get('url')||'').toString().trim(),
          slot:  clampSlot(fd.get('slot')),
          map:   (fd.get('map')||'').toString().trim() || null,
          thumb: (fd.get('thumb')||'').toString().trim() || null,
          date:  dateRaw ? new Date(dateRaw).toISOString() : null,
          approved: false
        };

        if(!isValidClipUrl(payload.url)){ status.textContent='Please enter a Twitch or YouTube URL.'; return; }

        // Live pre-check: block if any row already exists for this slot (approved or not)
        try{
          const existsRes = await fetch(`${SUPABASE_URL}/rest/v1/kacky_clips?slot=eq.${encodeURIComponent(payload.slot)}&select=slot`, H);
          const exists = await existsRes.json();
          if(Array.isArray(exists) && exists.length){ status.textContent='‚ùå This slot already has a submission.'; return; }
        }catch{}

        status.textContent='Sending‚Ä¶';
        try{
          const res = await fetch(`${SUPABASE_URL}/rest/v1/kacky_clips`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...H.headers, Prefer:'return=minimal' },
            body: JSON.stringify(payload)
          });

          if(!res.ok){
            const txt = await res.text();
            if(res.status===409){ status.textContent='‚ùå Slot already taken.'; return; }
            status.textContent = `‚ö†Ô∏è ${res.status} ${txt || 'Submission failed'}`;
            console.error('Supabase insert error:', res.status, txt);
            return;
          }

          status.textContent='‚úÖ Submitted! Awaiting approval.';
          form.reset();
          setTimeout(()=>{ closeSubmit(); status.textContent=''; loadClips(); }, 1000);
        }catch(err){ console.error(err); status.textContent='‚ö†Ô∏è Network error. Please try again later.'; }
      });
    })();

    // Initial load
    loadClips();
  </script>
</body>
</html>
