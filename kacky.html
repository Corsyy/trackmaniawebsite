<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kacky Finishes ‚Äî Trackmania Events</title>
  <meta name="description" content="Upload and view Trackmania Kacky finish clips. Community submissions, moderated for quality." />
  <style>
    body{margin:0;font-family:system-ui;background:#0a0f1a;color:#e6ecff;}
    header{background:#0f1524;padding:1rem 0;position:sticky;top:0;z-index:50;border-bottom:1px solid rgba(109,251,255,.2);}
    .nav-container{width:min(1200px,92vw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;}
    .brand{font-weight:800;font-size:1.2rem;letter-spacing:.3px;display:flex;align-items:center;gap:.4rem;color:#6dfbff;}
    .btn-nav{padding:.5rem 1rem;border:1px solid rgba(109,251,255,.3);border-radius:10px;background:linear-gradient(135deg,#3aa0ff,#6dfbff);color:#001220;font-weight:700;cursor:pointer;text-decoration:none;transition:.2s;}
    .btn-nav:hover{transform:translateY(-1px);}

    .container{width:min(1200px,92vw);margin:0 auto;padding:2rem 0;}
    h1{font-size:2.2rem;margin-bottom:1rem;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;}
    .card{background:linear-gradient(180deg,rgba(10,15,26,.85),rgba(10,15,26,.6));border:1px solid rgba(109,251,255,.15);border-radius:14px;padding:1rem;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;min-height:180px;}
    .card iframe{width:100%;border-radius:10px;}
    .btn{padding:.6rem 1rem;border:none;border-radius:10px;background:linear-gradient(135deg,#3aa0ff,#6dfbff);color:#001220;font-weight:700;cursor:pointer;transition:.2s;}
    .btn:hover{transform:translateY(-1px);}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100;}
    .modal.open{display:flex;}
    .modal-content{background:#0f1524;padding:2rem;border-radius:12px;width:min(700px,90vw);}
    .input{width:100%;padding:.7rem .9rem;margin:.4rem 0;border-radius:10px;border:1px solid rgba(109,251,255,.25);background:#0c1224;color:#e6ecff;}
  </style>
</head>
<body>
  <header>
    <div class="nav-container">
      <div class="brand">üèéÔ∏è Kacky Finishes</div>
      <a href="/" class="btn-nav">Home</a>
    </div>
  </header>

  <div class="container">
    <h1>Kacky Finishes</h1>
    <p>Upload your Kacky finish clips below! Approved clips will appear automatically once reviewed.</p>
    <button class="btn" id="openSubmit">Submit a Clip</button>
    <div id="clipsGrid" class="grid"></div>
  </div>

  <div class="modal" id="submit-modal">
    <div class="modal-content">
      <h2>Submit Your Kacky Clip</h2>
      <form id="submitForm">
        <input class="input" name="title" placeholder="Title" required />
        <input class="input" name="slot" type="number" min="1" max="75" placeholder="Slot # (1‚Äì75)" required />
        <input class="input" name="url" placeholder="Twitch or YouTube URL" required />
        <input class="input" name="map" placeholder="Map (optional)" />
        <input class="input" name="thumb" placeholder="Thumbnail URL (optional)" />
        <input class="input" name="date" type="datetime-local" />
        <div style="display:flex;gap:.6rem;margin-top:.6rem;align-items:center;">
          <button class="btn" type="submit">Send</button>
          <button class="btn" type="button" id="closeSubmit">Cancel</button>
          <span id="submitStatus" style="margin-left:.6rem;font-size:.9rem;"></span>
        </div>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://lertzsobphopkoyaxrwk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlcnR6c29icGhvcGtveWF4cndrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MjU4MzksImV4cCI6MjA3NjQwMTgzOX0.Vgpdlh8MHG21QIQW10iL1pztUYRPxJXTHMwg0gTPlWI";

    // Build a safe embed URL for Twitch/YouTube with correct parameters
    function buildEmbedURL(raw){
      try{
        const u = new URL(raw);
        const host = u.hostname.replace(/^www\./,'');
        const parent = location.hostname || 'trackmaniaevents.com';

        // --- YouTube ---
        if (host === 'youtube.com' || host === 'm.youtube.com') {
          // watch?v=ID
          const id = u.searchParams.get('v');
          if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}`;
          // shorts
          const parts = u.pathname.split('/').filter(Boolean);
          if (parts[0] === 'shorts' && parts[1]) {
            return `https://www.youtube.com/embed/${encodeURIComponent(parts[1])}`;
          }
        }
        if (host === 'youtu.be') {
          const id = u.pathname.replace('/','');
          if (id) return `https://www.youtube.com/embed/${encodeURIComponent(id)}`;
        }

        // --- Twitch ---
        if (host === 'clips.twitch.tv') {
          // https://clips.twitch.tv/Slug
          const slug = u.pathname.split('/').filter(Boolean)[0];
          if (slug) return `https://clips.twitch.tv/embed?clip=${encodeURIComponent(slug)}&parent=${encodeURIComponent(parent)}&autoplay=false`;
        }
        if (host.endsWith('twitch.tv')) {
          const parts = u.pathname.split('/').filter(Boolean);
          // /<channel>/clip/<slug>
          const clipIdx = parts.indexOf('clip');
          if (clipIdx >= 0 && parts[clipIdx+1]) {
            const slug = parts[clipIdx+1];
            return `https://clips.twitch.tv/embed?clip=${encodeURIComponent(slug)}&parent=${encodeURIComponent(parent)}&autoplay=false`;
          }
          // /videos/<id>
          const vIdx = parts.indexOf('videos');
          if (vIdx >= 0 && parts[vIdx+1]) {
            return `https://player.twitch.tv/?video=${encodeURIComponent(parts[vIdx+1])}&parent=${encodeURIComponent(parent)}&autoplay=false`;
          }
          // channel live embed
          if (parts[0]) {
            return `https://player.twitch.tv/?channel=${encodeURIComponent(parts[0])}&parent=${encodeURIComponent(parent)}&autoplay=false`;
          }
        }

        // Fallback to raw URL if nothing matched
        return raw;
      }catch(e){
        return raw;
      }
    }

    async function loadClips(){
      try{
        const res = await fetch(`${SUPABASE_URL}/rest/v1/kacky_clips?approved=eq.true&select=slot,title,url,map,date,thumb`, {
          headers:{apikey:SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}`}
        });
        const clips = await res.json();
        render(clips);
      }catch(err){
        console.error(err);
        document.getElementById('clipsGrid').innerHTML = '<p>Failed to load clips.</p>';
      }
    }

    function render(clips){
      const grid = document.getElementById('clipsGrid');
      grid.innerHTML = '';
      for(let i=1;i<=75;i++){
        const clip = clips.find(c => c.slot===i);
        const div = document.createElement('div');
        div.className = 'card';
        if(clip){
          const src = buildEmbedURL(clip.url);
          div.innerHTML = `<strong>${clip.title}</strong><br>
                           <iframe width="100%" height="160" src="${src}" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
        } else {
          div.innerHTML = `<em>Slot ${i}</em><br><button class='btn upload' data-slot='${i}'>Upload</button>`;
        }
        grid.appendChild(div);
      }
    }

    // Modal open/close
    const openBtn=document.getElementById('openSubmit');
    const modal=document.getElementById('submit-modal');
    const closeBtn=document.getElementById('closeSubmit');
    openBtn.onclick=()=>modal.classList.add('open');
    closeBtn.onclick=()=>modal.classList.remove('open');
    modal.addEventListener('click',e=>{if(e.target===modal)modal.classList.remove('open');});

    // Form submission (with helpful error)
    (function(){
      const form=document.getElementById('submitForm');
      const status=document.getElementById('submitStatus');

      function isValidClipUrl(u){
        try{ const h=new URL(u).hostname; return /twitch\.tv|youtube\.com|youtu\.be/i.test(h); }
        catch{return false;}
      }
      function clampSlot(n){ n=Number(n||0); return Math.min(75, Math.max(1, n)); }

      form?.addEventListener('submit', async e => {
        e.preventDefault();
        status.textContent='Sending‚Ä¶';

        const fd = new FormData(form);
        const dateRaw = (fd.get('date')||'').toString().trim();
        const payload = {
          title: (fd.get('title')||'').toString().trim(),
          url:   (fd.get('url')||'').toString().trim(),
          slot:  clampSlot(fd.get('slot')),
          map:   (fd.get('map')||'').toString().trim() || null,
          thumb: (fd.get('thumb')||'').toString().trim() || null,
          date:  dateRaw ? new Date(dateRaw).toISOString() : null,
          approved: false
        };

        if(!isValidClipUrl(payload.url)){
          status.textContent = 'Please enter a Twitch or YouTube URL.';
          return;
        }

        try{
          const res = await fetch(`${SUPABASE_URL}/rest/v1/kacky_clips`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              Prefer: 'return=minimal'
            },
            body: JSON.stringify(payload)
          });

          if(!res.ok){
            const txt = await res.text();
            status.textContent = `‚ö†Ô∏è ${res.status} ${txt || 'Submission failed'}`;
            console.error('Supabase insert error:', res.status, txt);
            return;
          }

          status.textContent='‚úÖ Submitted! Awaiting approval.';
          form.reset();
          setTimeout(()=>{ modal.classList.remove('open'); status.textContent=''; },1200);
        }catch(err){
          console.error(err);
          status.textContent='‚ö†Ô∏è Network error. Please try again later.';
        }
      });
    })();

    loadClips();
  </script>
</body>
</html>
