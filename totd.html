<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Track of the Day</title>
<style>
:root{--bg:#0a0f1a;--panel:#0f1524;--text:#e6ecff;--muted:#9db1ff;--accent:#6dfbff;--border:rgba(109,251,255,.2)}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Helvetica Neue,sans-serif;background:var(--bg);color:var(--text)}
header{background:var(--panel);border-bottom:1px solid var(--border)}
.container{width:min(1100px,92vw);margin:0 auto;padding:1rem}
h1{margin:0 0 .25rem}
.nav{display:flex;justify-content:space-between;align-items:center;gap:1rem}
.nav a{color:var(--accent);text-decoration:none;margin-right:1rem}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-top:1rem}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.thumb{aspect-ratio:16/9;background:#08101c}.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.meta{padding:.8rem}.date{opacity:.8;font-size:.9rem}.badge{border:1px solid var(--border);padding:.2rem .5rem;border-radius:999px;font-size:.85rem;background:rgba(109,251,255,.06)}
.select{margin-top:.5rem}select{background:#0c1322;border:1px solid var(--border);color:var(--text);padding:.4rem .6rem;border-radius:10px}
.hero{display:flex;gap:1rem;margin:1rem 0;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:1rem}
.hero .thumb{width:320px;flex:0 0 auto}
@media(max-width:800px){.hero{flex-direction:column}.hero .thumb{width:auto}}

/* Gradient Home button to match Kacky page */
.home-btn{
  background:linear-gradient(90deg,#3ae0ff,#4d9fff);
  border:none;color:#000;font-weight:600;font-size:1rem;
  padding:.45rem 1.1rem;border-radius:.6rem;cursor:pointer;
  box-shadow:0 0 8px rgba(77,159,255,.5);transition:all .25s ease;
  animation:pulseGlow 2.5s infinite ease-in-out
}
.home-btn:hover{transform:translateY(-2px);box-shadow:0 0 14px rgba(58,224,255,.8)}
@keyframes pulseGlow{
  0%{box-shadow:0 0 8px rgba(77,159,255,.5)}
  50%{box-shadow:0 0 14px rgba(77,159,255,.9)}
  100%{box-shadow:0 0 8px rgba(77,159,255,.5)}
}

/* NEW: download button */
.download-btn{
  display:inline-block;
  background:linear-gradient(90deg,#3ae0ff,#4d9fff);
  color:#000;font-weight:600;padding:.35rem .75rem;border-radius:.5rem;
  text-decoration:none;border:1px solid var(--border);
}
.download-btn:hover{ filter:brightness(1.06); }
</style>
</head>
<body>
<header><div class="container">
  <div class="nav">
    <h1>Track of the Day</h1>
    <a href="/"><button class="home-btn">Home</button></a>
  </div>
  <div class="nav" style="justify-content:flex-start;gap:1rem">
    <a href="./cotd">Cup of the Day</a>
  </div>
  <div class="select">Month: <select id="month"></select></div>
</div></header>

<main class="container">
  <section id="today" class="hero">
    <div class="thumb" id="t-thumb"></div>
    <div>
      <h2 id="t-name">(loading…)</h2>
      <p>Author: <span class="badge" id="t-author">—</span></p>
      <p id="t-date" class="date"></p>
      <!-- download button for Today gets injected here if available -->
    </div>
  </section>
  <section class="grid" id="grid"></section>
</main>

<script>
(function(){
  const MONTHS=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const bust=()=>`?t=${Date.now()}`;
  const label=(ym)=>{const [y,m]=ym.split("-");return `${MONTHS[+m-1]} ${y}`;}
  const maxKey=(obj)=>Object.keys(obj||{}).sort().pop();

  async function jget(url){
    const r=await fetch(url+bust(),{cache:"no-store"});
    if(!r.ok) throw new Error(`${url} -> ${r.status}`);
    return r.json();
  }
  const set=(id,html)=>{const el=document.getElementById(id); if(el) el.innerHTML=html;}
  const setText=(id,txt)=>{const el=document.getElementById(id); if(el) el.textContent=txt??"";}

  // UPDATED: hero now renders a download button if map.downloadUrl exists
  function renderHero(rec){
    if(!rec) return;
    const dl = rec.map?.downloadUrl || null;
    set("t-thumb",
      rec.map?.thumbnailUrl
        ? `<img src="${rec.map.thumbnailUrl}" referrerpolicy="no-referrer" alt="Map thumbnail">`
        : ""
    );
    setText("t-name",   rec.map?.name || "(unknown map)");
    setText("t-author", rec.map?.authorDisplayName || "—");
    setText("t-date",   rec.date || "");

    const hero = document.getElementById("today");
    // remove any old button
    const old = hero.querySelector(".today-dl");
    if (old) old.remove();
    // add new if available
    if (dl){
      const div = document.createElement("div");
      div.className = "today-dl";
      div.style.marginTop = ".5rem";
      div.innerHTML = `<a class="download-btn" href="${dl}" target="_blank" rel="noopener">⬇️ Download Today’s Map</a>`;
      hero.appendChild(div);
    }
  }

  // UPDATED: cards also show the button if map.downloadUrl exists
  function renderGrid(days){
    const grid=document.getElementById("grid");
    if(!grid) return;
    grid.innerHTML="";
    const keys=Object.keys(days).sort(); // oldest -> newest
    for(const k of keys){
      const d=days[k];
      const dl = d.map?.downloadUrl || null;

      const card=document.createElement("article");
      card.className="card";
      card.innerHTML=`
        <div class="thumb">
          ${d.map?.thumbnailUrl ? `<img loading="lazy" referrerpolicy="no-referrer" src="${d.map.thumbnailUrl}" alt="">` : ""}
        </div>
        <div class="meta">
          <div class="date">${d.date}</div>
          <h3>${d.map?.name || "(unknown map)"}</h3>
          <div>Author: <span class="badge">${d.map?.authorDisplayName || "—"}</span></div>
          ${dl ? `<div style="margin-top:.6rem"><a class="download-btn" href="${dl}" target="_blank" rel="noopener">⬇️ Download Map</a></div>` : ""}
        </div>`;
      grid.appendChild(card);
    }
  }

  async function loadMonth(ym){
    const month=await jget(`data/totd/${ym}.json`);
    const latest=month.days[maxKey(month.days)];   // latest in that month
    renderHero(latest);
    renderGrid(month.days);
  }

  async function init(){
    const sel=document.getElementById("month");
    const monthsJ=await jget("data/totd/months.json");
    const months=(monthsJ?.months||[]).slice().sort().reverse(); // newest first
    if(!months.length){ if(sel) sel.innerHTML=`<option>(no data yet)</option>`; return; }
    if(sel){
      sel.innerHTML=months.map(k=>`<option value="${k}">${label(k)}</option>`).join("");
      sel.value=months[0];
      sel.onchange=()=>loadMonth(sel.value);
    }
    await loadMonth(months[0]);
  }

  init().catch(err=>{
    console.error("[TOTD] init failed:",err);
    setText("t-name","(failed to load)");
  });
})();
</script>
</body>
</html>
